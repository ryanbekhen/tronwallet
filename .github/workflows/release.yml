name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.25"

      - name: Generate changelog
        id: changelog
        run: |
          git fetch --prune --unshallow || true
          git fetch --tags --force || true

          CUR_TAG=${GITHUB_REF_NAME}
          ROOT_COMMIT=$(git rev-list --max-parents=0 HEAD)
          RANGE="$ROOT_COMMIT..HEAD"

          echo "Generating changelog for range: $RANGE"

          # We'll iterate commits and try to find a Conventional Commit line either in the subject
          # or in the body (useful when merges contain the PR title in the body).
          FEATURES=""
          FIXES=""
          DOCS=""
          CHORES=""
          REFACTORS=""
          TESTS=""
          CI=""
          OTHER=""

          # Use ASCII record separators to safely split commits
          git log $RANGE --pretty=format:'%H%x1f%s%x1f%b%x1e' | \
          awk -v RS="\x1e" -v FS="\x1f" '{print $1 "\nSUBJECT:" $2 "\nBODY:" $3 "\n---"}' | \
          while IFS= read -r line; do
            # collect blocks: HASH, SUBJECT, BODY
            if [[ "$line" =~ ^([0-9a-f]{7,})$ ]]; then
              HASH="$line"
              continue
            fi
            if [[ "$line" =~ ^SUBJECT:(.*)$ ]]; then
              SUBJECT="${BASH_REMATCH[1]}"
              continue
            fi
            if [[ "$line" =~ ^BODY:(.*)$ ]]; then
              BODY="${BASH_REMATCH[1]}"
              # Now process this commit: look for a Conventional Commit line in SUBJECT or BODY
              # Prefer subject; if subject is a generic merge message, look into body
              CLEAN_LINE=""
              # Accept optional leading list markers like "- " or "* " before the type
              if echo "$SUBJECT" | grep -iE '^\s*[-*]?\s*(feat|fix|docs|chore|refactor|test|ci)(\([^)]+\))?:' >/dev/null 2>&1; then
                # strip any leading list marker and surrounding whitespace
                CLEAN_LINE=$(echo "$SUBJECT" | sed -E 's/^\s*[-*]?\s*//')
              else
                # search body for a conventional-commit like line; allow leading list markers
                CLEAN_LINE=$(echo "$BODY" | grep -iE '^\s*[-*]?\s*(feat|fix|docs|chore|refactor|test|ci)(\([^)]+\))?:' | head -n1 || true)
                # strip marker if present
                CLEAN_LINE=$(echo "$CLEAN_LINE" | sed -E 's/^\s*[-*]?\s*//')
              fi

              # If we found a matching line, categorize it; otherwise put the subject into Other
              if [ -n "$CLEAN_LINE" ]; then
                # normalize leading/trailing whitespace and ensure it starts with a dash
                LINE="- $(echo "$CLEAN_LINE" | sed -E 's/^\s+//; s/\s+$//')"
                case "$(echo "$CLEAN_LINE" | tr '[:upper:]' '[:lower:]')" in
                  feat* ) FEATURES="$FEATURES\n$LINE" ;;
                  fix* ) FIXES="$FIXES\n$LINE" ;;
                  docs* ) DOCS="$DOCS\n$LINE" ;;
                  chore* ) CHORES="$CHORES\n$LINE" ;;
                  refactor* ) REFACTORS="$REFACTORS\n$LINE" ;;
                  test* ) TESTS="$TESTS\n$LINE" ;;
                  ci* ) CI="$CI\n$LINE" ;;
                  * ) OTHER="$OTHER\n$LINE" ;;
                esac
              else
                OTHER="$OTHER\n- $SUBJECT"
              fi

              # reset SUBJECT/BODY for next commit
              SUBJECT=""
              BODY=""
            fi
          done

          # write changelog
          echo "## Changes in $CUR_TAG" > CHANGELOG.md
          if [ -n "$(echo "$FEATURES" | tr -d '\n' | sed 's/ //g')" ]; then
            echo -e "\n### Features" >> CHANGELOG.md
            echo "$FEATURES" | sed '/^$/d' >> CHANGELOG.md
          fi
          if [ -n "$(echo "$FIXES" | tr -d '\n' | sed 's/ //g')" ]; then
            echo -e "\n### Bug Fixes" >> CHANGELOG.md
            echo "$FIXES" | sed '/^$/d' >> CHANGELOG.md
          fi
          if [ -n "$(echo "$DOCS" | tr -d '\n' | sed 's/ //g')" ]; then
            echo -e "\n### Documentation" >> CHANGELOG.md
            echo "$DOCS" | sed '/^$/d' >> CHANGELOG.md
          fi
          if [ -n "$(echo "$CHORES" | tr -d '\n' | sed 's/ //g')" ]; then
            echo -e "\n### Chores" >> CHANGELOG.md
            echo "$CHORES" | sed '/^$/d' >> CHANGELOG.md
          fi
          if [ -n "$(echo "$REFACTORS" | tr -d '\n' | sed 's/ //g')" ]; then
            echo -e "\n### Refactors" >> CHANGELOG.md
            echo "$REFACTORS" | sed '/^$/d' >> CHANGELOG.md
          fi
          if [ -n "$(echo "$TESTS" | tr -d '\n' | sed 's/ //g')" ]; then
            echo -e "\n### Tests" >> CHANGELOG.md
            echo "$TESTS" | sed '/^$/d' >> CHANGELOG.md
          fi
          if [ -n "$(echo "$CI" | tr -d '\n' | sed 's/ //g')" ]; then
            echo -e "\n### CI" >> CHANGELOG.md
            echo "$CI" | sed '/^$/d' >> CHANGELOG.md
          fi
          if [ -n "$(echo "$OTHER" | tr -d '\n' | sed 's/ //g')" ]; then
            echo -e "\n### Other" >> CHANGELOG.md
            echo "$OTHER" | sed '/^$/d' >> CHANGELOG.md
          fi

          echo "----- GENERATED CHANGELOG -----"
          cat CHANGELOG.md
          echo "-------------------------------"

          echo "release_body<<EOF" >> $GITHUB_OUTPUT
          cat CHANGELOG.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          body: ${{ steps.changelog.outputs.release_body }}